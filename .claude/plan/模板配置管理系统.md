# æ¨¡æ¿é…ç½®ç®¡ç†ç³»ç»Ÿ - å®æ–½è®¡åˆ’

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®ç›®æ ‡
å°†ç°æœ‰çš„é™æ€é¡µé¢ç®¡ç†ç³»ç»Ÿæ”¹é€ ä¸ºåŸºäº MongoDB çš„åŠ¨æ€å¯é…ç½®ç³»ç»Ÿï¼Œæ”¯æŒï¼š
- å…¬å…±æ¨¡æ¿ç®¡ç†
- æ¨¡æ¿å¤åˆ¶ä¸å®šåˆ¶
- è·¯ç”±è§„åˆ™åŠ¨æ€ç»‘å®šï¼ˆæ”¯æŒæ³›åŒ¹é…ï¼‰
- åŸºäºåŸŸåçš„å¤šç§Ÿæˆ·éš”ç¦»

### æŠ€æœ¯æ ˆ
- **åç«¯**: Koa + Mongoose
- **æ•°æ®åº“**: MongoDBï¼ˆDocker Compose æœ¬åœ°éƒ¨ç½²ï¼‰
- **å‰ç«¯**: åŸç”Ÿ HTML + Tailwind CSS + Alpine.js
- **ç¼“å­˜**: å†…å­˜ç¼“å­˜ï¼ˆMapï¼‰

### é¢„ä¼°æ—¶é—´
- **æ€»è®¡**: çº¦ 5.5 å°æ—¶ï¼ˆ1 ä¸ªå·¥ä½œæ—¥ï¼‰
- **æ ¸å¿ƒåŠŸèƒ½**: 3 å°æ—¶
- **ç®¡ç†ç•Œé¢**: 2 å°æ—¶
- **æµ‹è¯•æ–‡æ¡£**: 0.5 å°æ—¶

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µæ¨¡å‹

```
åŸŸå(host) â†’ è·¯ç”±è§„åˆ™ â†’ æ¨¡æ¿å®ä¾‹ â†’ HTML å†…å®¹
   â†“           â†“           â†“
ä¾‹ï¼šblaze.com  /proto/child-safety-*  æ¨¡æ¿A(åŸºäºå…¬å…±æ¨¡æ¿)  æ¸²æŸ“é¡µé¢
```

### æ•°æ®æµ
1. ç”¨æˆ·è¯·æ±‚ â†’ `x-forwarded-host: blaze.com` + `/proto/child-safety-xxx`
2. æ¨¡æ¿è§£æå™¨ â†’ æŸ¥è¯¢è·¯ç”±è§„åˆ™ï¼ˆdomain + pattern åŒ¹é…ï¼‰
3. åŒ¹é…æˆåŠŸ â†’ è¯»å–æ¨¡æ¿å†…å®¹ + æ¸²æŸ“å˜é‡
4. è¿”å› HTML â†’ ç”¨æˆ·æµè§ˆå™¨

---

## ğŸ“ å®æ–½æ­¥éª¤è¯¦è§£

### é˜¶æ®µ 1ï¼šåŸºç¡€è®¾æ–½å‡†å¤‡ï¼ˆ30 åˆ†é’Ÿï¼‰

#### 1.1 åˆ›å»º Docker Compose é…ç½®
**æ–‡ä»¶**: `docker-compose.yml`

**å†…å®¹**:
```yaml
version: '3.8'

services:
  mongodb:
    image: mongo:7.0
    container_name: webpage-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: webpage-config
    volumes:
      - mongodb_data:/data/db
    networks:
      - webpage-network

  mongo-express:
    image: mongo-express:latest
    container_name: webpage-mongo-express
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin123
    depends_on:
      - mongodb
    networks:
      - webpage-network

volumes:
  mongodb_data:

networks:
  webpage-network:
    driver: bridge
```

**æ“ä½œ**:
```bash
docker-compose up -d
docker-compose ps  # éªŒè¯å¯åŠ¨
```

**é¢„æœŸç»“æœ**:
- MongoDB è¿è¡Œåœ¨ `localhost:27017`
- Mongo Express è¿è¡Œåœ¨ `localhost:8081`

---

#### 1.2 å®‰è£…ä¾èµ–åŒ…
**æ–‡ä»¶**: `package.json`

**æ·»åŠ ä¾èµ–**:
```json
{
  "dependencies": {
    "mongoose": "^8.0.0",
    "js-yaml": "^4.1.0"
  }
}
```

**æ“ä½œ**:
```bash
yarn add mongoose js-yaml
```

**é¢„æœŸç»“æœ**: `node_modules` ä¸­åŒ…å«æ–°ä¾èµ–

---

#### 1.3 ç¯å¢ƒé…ç½®
**æ–‡ä»¶**: `.env.example`, `.env`

**æ·»åŠ é…ç½®**:
```bash
# MongoDB é…ç½®
MONGODB_URI=mongodb://localhost:27017/webpage-config
```

**é¢„æœŸç»“æœ**: ç¯å¢ƒå˜é‡å¯è¢«æ­£ç¡®è¯»å–

---

### é˜¶æ®µ 2ï¼šæ•°æ®æ¨¡å‹ä¸æœåŠ¡å±‚ï¼ˆ1 å°æ—¶ï¼‰

#### 2.1 åˆ›å»º MongoDB æ•°æ®æ¨¡å‹

##### BaseTemplateï¼ˆå…¬å…±æ¨¡æ¿ï¼‰
**æ–‡ä»¶**: `src/models/BaseTemplate.js`

**Schema è®¾è®¡**:
```javascript
{
  name: String,           // child-safety, privacy-policy (å”¯ä¸€ç´¢å¼•)
  displayName: String,    // å„¿ç«¥å®‰å…¨æ”¿ç­–
  category: String,       // policy, terms, safety, other
  filePath: String,       // templates/base/child-safety.html
  content: String,        // HTML å†…å®¹
  variables: [{          // å¯é…ç½®å˜é‡
    name: String,        // app_name, email
    type: String,        // text, email, url, image
    required: Boolean,
    defaultValue: String
  }],
  description: String,
  createdAt: Date,
  updatedAt: Date
}
```

**ç´¢å¼•**:
- `name` å”¯ä¸€ç´¢å¼•
- `category + createdAt` å¤åˆç´¢å¼•

---

##### CustomTemplateï¼ˆå®šåˆ¶æ¨¡æ¿ï¼‰
**æ–‡ä»¶**: `src/models/CustomTemplate.js`

**Schema è®¾è®¡**:
```javascript
{
  name: String,                  // blaze-child-safety
  displayName: String,           // Blaze å„¿ç«¥å®‰å…¨æ”¿ç­–
  baseTemplateId: ObjectId,      // å…³è”å…¬å…±æ¨¡æ¿
  domain: String,                // blaze.com
  content: String,               // å®šåˆ¶åçš„ HTML
  variables: Map<String, String>, // å˜é‡å€¼æ˜ å°„
  filePath: String,              // templates/custom/blaze-child-safety.html
  status: String,                // draft, active, archived
  version: Number,
  createdBy: String,
  createdAt: Date,
  updatedAt: Date
}
```

**ç´¢å¼•**:
- `domain + status` å¤åˆç´¢å¼•
- `baseTemplateId` ç´¢å¼•

---

##### RouteRuleï¼ˆè·¯ç”±è§„åˆ™ï¼‰
**æ–‡ä»¶**: `src/models/RouteRule.js`

**Schema è®¾è®¡**:
```javascript
{
  pattern: String,        // /proto/child-safety-*, /a/b
  type: String,           // exact, wildcard, regex
  domain: String,         // blaze.com æˆ– 'default'
  templateId: ObjectId,   // å…³è”å®šåˆ¶æ¨¡æ¿
  priority: Number,       // ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆï¼‰
  enabled: Boolean,
  description: String,
  createdAt: Date,
  updatedAt: Date
}
```

**ç´¢å¼•**:
- `domain + enabled + priority` å¤åˆç´¢å¼•ï¼ˆæŸ¥è¯¢ä¼˜åŒ–ï¼‰

---

##### Domainï¼ˆåŸŸåé…ç½®ï¼‰
**æ–‡ä»¶**: `src/models/Domain.js`

**Schema è®¾è®¡**:
```javascript
{
  host: String,                 // blaze.com (å”¯ä¸€ç´¢å¼•)
  appName: String,              // Zona Live
  email: String,
  config: Map<String, Mixed>,   // å…¶ä»–é…ç½®
  defaultTemplatePrefix: String, // custom/blaze-
  status: String,               // active, inactive
  createdAt: Date,
  updatedAt: Date
}
```

**ç´¢å¼•**:
- `host` å”¯ä¸€ç´¢å¼•

---

#### 2.2 å®ç° MongoDB è¿æ¥æœåŠ¡
**æ–‡ä»¶**: `src/services/mongo.js`

**æ ¸å¿ƒé€»è¾‘**:
```javascript
const mongoose = require('mongoose')

const connectDB = async () => {
  await mongoose.connect(process.env.MONGODB_URI, {
    useNewUrlParser: true,
    useUnifiedTopology: true
  })
  console.log('âœ“ MongoDB è¿æ¥æˆåŠŸ')
}

module.exports = connectDB
```

**é¢„æœŸç»“æœ**: åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥ MongoDB

---

#### 2.3 å®ç°ç¼“å­˜æœåŠ¡
**æ–‡ä»¶**: `src/services/cache.js`

**æ ¸å¿ƒåŠŸèƒ½**:
- `get(key)` - è¯»å–ç¼“å­˜ï¼ˆå«è¿‡æœŸæ£€æŸ¥ï¼‰
- `set(key, value, ttl)` - å†™å…¥ç¼“å­˜ï¼ˆé»˜è®¤ TTL 300sï¼‰
- `clear(pattern)` - æ¸…é™¤ç¼“å­˜ï¼ˆæ”¯æŒé€šé…ç¬¦ `*`ï¼‰

**å®ç°**:
```javascript
class MemoryCache {
  constructor() {
    this.cache = new Map()
  }

  get(key) {
    const item = this.cache.get(key)
    if (!item || Date.now() > item.expires) {
      this.cache.delete(key)
      return null
    }
    return item.value
  }

  set(key, value, ttl = 300) {
    this.cache.set(key, {
      value,
      expires: Date.now() + ttl * 1000
    })
  }

  clear(pattern) {
    if (pattern.includes('*')) {
      const regex = new RegExp('^' + pattern.replace(/\*/g, '.*') + '$')
      for (const key of this.cache.keys()) {
        if (regex.test(key)) this.cache.delete(key)
      }
    } else {
      this.cache.delete(pattern)
    }
  }
}
```

**é¢„æœŸç»“æœ**: ç¼“å­˜è¯»å†™æµ‹è¯•é€šè¿‡

---

#### 2.4 å®ç°æ¨¡æ¿è§£æå¼•æ“ï¼ˆæ ¸å¿ƒï¼‰
**æ–‡ä»¶**: `src/services/template-resolver.js`

**æ ¸å¿ƒæ–¹æ³•**:

##### resolve(route, host)
- **è¾“å…¥**: `/proto/child-safety-blaze`, `blaze.example.com`
- **é€»è¾‘**:
  1. æå–åŸŸå â†’ `example.com`
  2. ç”Ÿæˆç¼“å­˜é”® â†’ `route:example.com:/proto/child-safety-blaze`
  3. å°è¯•è¯»ç¼“å­˜ â†’ å‘½ä¸­åˆ™è¿”å›
  4. æŸ¥è¯¢è·¯ç”±è§„åˆ™ï¼ˆdomain + enabled + æŒ‰ priority æ’åºï¼‰
  5. éå†è§„åˆ™ï¼ŒåŒ¹é…è·¯ç”±ï¼ˆexact/wildcard/regexï¼‰
  6. è¯»å–æ¨¡æ¿å†…å®¹ + æ¸²æŸ“å˜é‡
  7. å†™å…¥ç¼“å­˜ï¼ˆTTL 300sï¼‰
  8. è¿”å›æ¸²æŸ“ç»“æœ
- **è¾“å‡º**: `{ content: '<html>...', variables: {...}, templateName: 'xxx' }`

##### copyTemplate(baseTemplateId, name, domain, variables)
- **è¾“å…¥**: å…¬å…±æ¨¡æ¿ ID, æ–°åç§°, åŸŸå, å˜é‡å€¼
- **é€»è¾‘**:
  1. æŸ¥è¯¢å…¬å…±æ¨¡æ¿
  2. åˆ›å»ºå®šåˆ¶æ¨¡æ¿è®°å½•ï¼ˆcontent å¤åˆ¶è‡ªå…¬å…±æ¨¡æ¿ï¼‰
  3. åˆå¹¶å˜é‡å€¼
  4. å†™å…¥æ–‡ä»¶å¤‡ä»½åˆ° `templates/custom/`
- **è¾“å‡º**: æ–°æ¨¡æ¿å¯¹è±¡

##### bindRoute(pattern, type, domain, templateId, priority)
- **è¾“å…¥**: è·¯ç”±æ¨¡å¼, ç±»å‹, åŸŸå, æ¨¡æ¿ ID, ä¼˜å…ˆçº§
- **é€»è¾‘**:
  1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤ï¼‰
  2. åˆ›å»ºè·¯ç”±è§„åˆ™è®°å½•
  3. æ¸…é™¤ç›¸å…³ç¼“å­˜ `route:${domain}:*`
- **è¾“å‡º**: è·¯ç”±è§„åˆ™å¯¹è±¡

##### matchRoute(route, pattern, type)
- **è¾“å…¥**: `/proto/child-safety-blaze`, `/proto/child-safety-*`, `wildcard`
- **é€»è¾‘**:
  - `exact`: ç²¾ç¡®åŒ¹é…
  - `wildcard`: è½¬æ¢ä¸ºæ­£åˆ™ `^/proto/child-safety-.*$`
  - `regex`: ç›´æ¥æ­£åˆ™åŒ¹é…
- **è¾“å‡º**: true/false

##### renderTemplate(content, variables)
- **è¾“å…¥**: HTML å†…å®¹, å˜é‡ Map
- **é€»è¾‘**: æ›¿æ¢ `{app_name}` æˆ– `{ app_name }` ä¸ºå®é™…å€¼
- **è¾“å‡º**: æ¸²æŸ“åçš„ HTML

**é¢„æœŸç»“æœ**: æ‰€æœ‰æ–¹æ³•å•å…ƒæµ‹è¯•é€šè¿‡

---

### é˜¶æ®µ 3ï¼šç®¡ç†åå° APIï¼ˆ1 å°æ—¶ï¼‰

#### 3.1 æ¨¡æ¿ç®¡ç† API
**æ–‡ä»¶**: `src/routes/admin/templates.js`

**è·¯ç”±è®¾è®¡**:

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | å…¥å‚ | å‡ºå‚ |
|------|------|------|------|------|
| GET | `/api/admin/templates/base` | è·å–å…¬å…±æ¨¡æ¿åˆ—è¡¨ | - | `{ data: BaseTemplate[] }` |
| GET | `/api/admin/templates/custom` | è·å–å®šåˆ¶æ¨¡æ¿åˆ—è¡¨ | `domain`, `status` | `{ data: CustomTemplate[] }` |
| POST | `/api/admin/templates/copy` | å¤åˆ¶æ¨¡æ¿ | `baseTemplateId`, `name`, `domain`, `variables` | `{ data: CustomTemplate }` |
| PUT | `/api/admin/templates/:id` | æ›´æ–°æ¨¡æ¿ | `content`, `variables`, `status` | `{ data: CustomTemplate }` |
| DELETE | `/api/admin/templates/:id` | åˆ é™¤æ¨¡æ¿ | - | `{ success: true }` |

**æ ¸å¿ƒå®ç°**:
```javascript
// å¤åˆ¶æ¨¡æ¿
router.post('/copy', async ctx => {
  const { baseTemplateId, name, domain, variables } = ctx.request.body

  const customTemplate = await templateResolver.copyTemplate(
    baseTemplateId, name, domain, variables
  )

  ctx.body = { success: true, data: customTemplate }
})
```

**é¢„æœŸç»“æœ**: Postman æµ‹è¯•æ‰€æœ‰æ¥å£é€šè¿‡

---

#### 3.2 è·¯ç”±ç®¡ç† API
**æ–‡ä»¶**: `src/routes/admin/routes.js`

**è·¯ç”±è®¾è®¡**:

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | å…¥å‚ | å‡ºå‚ |
|------|------|------|------|------|
| GET | `/api/admin/routes` | è·å–è·¯ç”±è§„åˆ™åˆ—è¡¨ | `domain` | `{ data: RouteRule[] }` |
| POST | `/api/admin/routes` | åˆ›å»ºè·¯ç”±è§„åˆ™ | `pattern`, `type`, `domain`, `templateId`, `priority` | `{ data: RouteRule }` |
| PUT | `/api/admin/routes/:id` | æ›´æ–°è·¯ç”±è§„åˆ™ | `pattern`, `enabled`, `priority` | `{ data: RouteRule }` |
| DELETE | `/api/admin/routes/:id` | åˆ é™¤è·¯ç”±è§„åˆ™ | - | `{ success: true }` |

**é¢„æœŸç»“æœ**: è·¯ç”± CRUD æ¥å£æµ‹è¯•é€šè¿‡

---

#### 3.3 åŸŸåç®¡ç† API
**æ–‡ä»¶**: `src/routes/admin/domains.js`

**è·¯ç”±è®¾è®¡**:

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | å…¥å‚ | å‡ºå‚ |
|------|------|------|------|------|
| GET | `/api/admin/domains` | è·å–åŸŸååˆ—è¡¨ | - | `{ data: Domain[] }` |
| POST | `/api/admin/domains` | æ·»åŠ åŸŸå | `host`, `appName`, `email`, `config` | `{ data: Domain }` |
| PUT | `/api/admin/domains/:id` | æ›´æ–°åŸŸå | `appName`, `email`, `config` | `{ data: Domain }` |

**é¢„æœŸç»“æœ**: åŸŸåé…ç½®æ¥å£æµ‹è¯•é€šè¿‡

---

#### 3.4 é›†æˆåˆ°ä¸»è·¯ç”±
**æ–‡ä»¶**: `src/index.js`

**æ”¹åŠ¨**:
```javascript
const connectDB = require('./services/mongo')
const templateRoutes = require('./routes/admin/templates')
const routeRoutes = require('./routes/admin/routes')
const domainRoutes = require('./routes/admin/domains')

// è¿æ¥æ•°æ®åº“
connectDB()

// æ³¨å†Œç®¡ç†åå°è·¯ç”±
app.use(templateRoutes.routes())
app.use(routeRoutes.routes())
app.use(domainRoutes.routes())
```

**é¢„æœŸç»“æœ**: `/api/admin/*` è·¯ç”±å¯è®¿é—®

---

### é˜¶æ®µ 4ï¼šå‰å°è·¯ç”±æ”¹é€ ï¼ˆ30 åˆ†é’Ÿï¼‰

#### 4.1 æ”¹é€  proto è·¯ç”±
**æ–‡ä»¶**: `src/routes/proto/index.js`

**æ”¹åŠ¨å‰**:
```javascript
// ç¡¬ç¼–ç é€»è¾‘
if (viewsMap[view]) {
  context.body = renderHtml(...)
  return
}

if (redirectViewMap[view]) {
  view = redirectViewMap[view]
}

// API è·å–é…ç½®
const { email, app_name, ... } = await api.proto_config(...)
```

**æ”¹åŠ¨å**:
```javascript
const templateResolver = require('../../services/template-resolver')

module.exports = async function (context) {
  try {
    let { view } = context.params
    const host = process.env.NODE_ENV === 'development'
      ? process.env.TEST_HOST
      : context.req.headers['x-forwarded-host']

    const route = `/proto/${view}`

    // ä½¿ç”¨æ¨¡æ¿è§£æå¼•æ“
    const result = await templateResolver.resolve(route, host)

    context.set('Content-Type', 'text/html; charset=utf-8')
    context.body = result.content

  } catch (error) {
    context.status = 500
    context.body = `<h1>500 - ${error.message}</h1>`
  }
}
```

**é¢„æœŸç»“æœ**: `/proto/*` è·¯ç”±åŠ¨æ€ä»æ•°æ®åº“è¯»å–é…ç½®

---

#### 4.2 å…¼å®¹æ€§å¤„ç†
**æ”¹åŠ¨**:
```javascript
try {
  const result = await templateResolver.resolve(route, host)
  context.body = result.content
} catch (error) {
  console.error('æ¨¡æ¿è§£æå¤±è´¥ï¼Œé™çº§åˆ°ç¡¬ç¼–ç é€»è¾‘', error)

  // é™çº§é€»è¾‘ï¼šä½¿ç”¨åŸæ¥çš„ viewsMap
  if (viewsMap[view]) {
    context.body = renderHtml(viewsMap[view])
    return
  }

  throw error
}
```

**é¢„æœŸç»“æœ**: MongoDB æŒ‚æ‰æ—¶ï¼ŒæœåŠ¡ä»å¯ç”¨

---

### é˜¶æ®µ 5ï¼šç®¡ç†åå°å‰ç«¯ï¼ˆ1.5 å°æ—¶ï¼‰

#### 5.1 åˆ›å»ºå¸ƒå±€æ¡†æ¶
**æ–‡ä»¶**: `admin/index.html`

**ç»“æ„**:
```html
<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-100">
  <!-- å¯¼èˆªèœå• -->
  <nav class="bg-white shadow">
    <a href="/admin/templates.html">æ¨¡æ¿ç®¡ç†</a>
    <a href="/admin/routes.html">è·¯ç”±ç®¡ç†</a>
    <a href="/admin/domains.html">åŸŸåç®¡ç†</a>
  </nav>

  <!-- å†…å®¹åŒºåŸŸ -->
  <div id="content"></div>
</body>
</html>
```

**é¢„æœŸç»“æœ**: è®¿é—® `/admin` æ˜¾ç¤ºç®¡ç†ç•Œé¢

---

#### 5.2 æ¨¡æ¿ç®¡ç†é¡µé¢
**æ–‡ä»¶**: `admin/templates.html`

**åŠŸèƒ½æ¨¡å—**:

1. **å…¬å…±æ¨¡æ¿åˆ—è¡¨**
   - å±•ç¤ºæ‰€æœ‰å…¬å…±æ¨¡æ¿ï¼ˆåç§°ã€åˆ†ç±»ã€å˜é‡ï¼‰
   - æ“ä½œï¼šå¤åˆ¶æŒ‰é’®

2. **å®šåˆ¶æ¨¡æ¿åˆ—è¡¨**
   - å±•ç¤ºå®šåˆ¶æ¨¡æ¿ï¼ˆåç§°ã€åŸŸåã€çŠ¶æ€ï¼‰
   - æ“ä½œï¼šç¼–è¾‘ã€åˆ é™¤æŒ‰é’®

3. **å¤åˆ¶æ¨¡æ¿å¯¹è¯æ¡†**
   - è¾“å…¥ï¼šæ–°åç§°ã€åŸŸåã€å˜é‡å€¼
   - æäº¤ååˆ·æ–°åˆ—è¡¨

4. **ç¼–è¾‘æ¨¡æ¿å¯¹è¯æ¡†**
   - Textarea ç¼–è¾‘ HTML å†…å®¹
   - ä¿å­˜åæ¸…é™¤ç¼“å­˜

**Alpine.js æ•°æ®ç»“æ„**:
```javascript
{
  baseTemplates: [],
  customTemplates: [],
  selectedTemplate: null,
  showCopyDialog: false,
  showEditDialog: false,

  async loadData() { ... },
  async copyTemplate() { ... },
  async editTemplate() { ... }
}
```

**é¢„æœŸç»“æœ**: å¯è§†åŒ–ç®¡ç†æ¨¡æ¿

---

#### 5.3 è·¯ç”±ç®¡ç†é¡µé¢
**æ–‡ä»¶**: `admin/routes.html`

**åŠŸèƒ½æ¨¡å—**:

1. **è·¯ç”±è§„åˆ™åˆ—è¡¨**
   - è¡¨æ ¼å±•ç¤ºï¼ˆè·¯ç”±ã€ç±»å‹ã€åŸŸåã€æ¨¡æ¿ã€ä¼˜å…ˆçº§ã€å¯ç”¨çŠ¶æ€ï¼‰
   - æ“ä½œï¼šç¼–è¾‘ã€åˆ é™¤ã€å¯ç”¨/ç¦ç”¨

2. **åˆ›å»ºè·¯ç”±è§„åˆ™è¡¨å•**
   - è·¯ç”±æ¨¡å¼ï¼ˆæ”¯æŒæ³›åŒ¹é… `*`ï¼‰
   - ç±»å‹é€‰æ‹©ï¼ˆexact/wildcard/regexï¼‰
   - åŸŸåé€‰æ‹©ï¼ˆä¸‹æ‹‰ï¼‰
   - æ¨¡æ¿é€‰æ‹©ï¼ˆä¸‹æ‹‰ï¼‰
   - ä¼˜å…ˆçº§ï¼ˆæ•°å­—ï¼‰

3. **ç¼–è¾‘è·¯ç”±è§„åˆ™**
   - å¼¹çª—ä¿®æ”¹å‚æ•°
   - ä¿å­˜åæ¸…é™¤ç¼“å­˜

**é¢„æœŸç»“æœ**: å¯è§†åŒ–é…ç½®è·¯ç”±

---

#### 5.4 åŸŸåç®¡ç†é¡µé¢
**æ–‡ä»¶**: `admin/domains.html`

**åŠŸèƒ½æ¨¡å—**:

1. **åŸŸååˆ—è¡¨**
   - å±•ç¤ºï¼ˆåŸŸåã€åº”ç”¨åç§°ã€é‚®ç®±ã€çŠ¶æ€ï¼‰
   - æ“ä½œï¼šç¼–è¾‘ã€ç¦ç”¨

2. **æ·»åŠ åŸŸåè¡¨å•**
   - åŸŸåã€åº”ç”¨åç§°ã€é‚®ç®±ã€å…¶ä»–é…ç½®ï¼ˆJSONï¼‰

**é¢„æœŸç»“æœ**: å¯è§†åŒ–ç®¡ç†åŸŸå

---

### é˜¶æ®µ 6ï¼šæ•°æ®è¿ç§»ä¸åˆå§‹åŒ–ï¼ˆ30 åˆ†é’Ÿï¼‰

#### 6.1 ç¼–å†™æ•°æ®è¿ç§»è„šæœ¬
**æ–‡ä»¶**: `scripts/init-db.js`

**é€»è¾‘**:
```javascript
const fs = require('fs')
const path = require('path')
const BaseTemplate = require('../src/models/BaseTemplate')
const RouteRule = require('../src/models/RouteRule')
const connectDB = require('../src/services/mongo')

async function initDB() {
  await connectDB()

  // 1. æ‰«æ templates/base/ ç›®å½•
  const baseDir = path.resolve(__dirname, '../templates/base')
  const files = fs.readdirSync(baseDir)

  // 2. å¯¼å…¥å…¬å…±æ¨¡æ¿
  for (const file of files) {
    if (!file.endsWith('.html')) continue

    const name = file.replace('.html', '')
    const content = fs.readFileSync(path.join(baseDir, file), 'utf8')

    await BaseTemplate.findOneAndUpdate(
      { name },
      {
        name,
        displayName: name,
        category: 'other',
        filePath: `templates/base/${file}`,
        content,
        variables: extractVariables(content)  // è‡ªåŠ¨æå–å˜é‡
      },
      { upsert: true, new: true }
    )

    console.log(`âœ“ å¯¼å…¥å…¬å…±æ¨¡æ¿: ${name}`)
  }

  // 3. è¿ç§»ç¡¬ç¼–ç è·¯ç”±è§„åˆ™
  // å°† viewsMap è½¬æ¢ä¸ºè·¯ç”±è§„åˆ™
  const viewsMap = {
    'eula': 'eula.html',
    'privacy-policy-techspire': 'policy/techspire.html',
    // ...
  }

  for (const [route, templatePath] of Object.entries(viewsMap)) {
    // åˆ›å»ºå¯¹åº”çš„è·¯ç”±è§„åˆ™...
  }

  console.log('âœ“ æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ')
  process.exit(0)
}

// è‡ªåŠ¨æå–æ¨¡æ¿å˜é‡ï¼ˆæ­£åˆ™åŒ¹é… {å˜é‡å}ï¼‰
function extractVariables(content) {
  const regex = /{(\w+)}/g
  const variables = new Set()
  let match

  while ((match = regex.exec(content)) !== null) {
    variables.add(match[1])
  }

  return Array.from(variables).map(name => ({
    name,
    type: 'text',
    required: false,
    defaultValue: ''
  }))
}

initDB()
```

**æ“ä½œ**:
```bash
node scripts/init-db.js
```

**é¢„æœŸç»“æœ**: æ‰€æœ‰å…¬å…±æ¨¡æ¿å¯¼å…¥ MongoDB

---

#### 6.2 åˆ›å»ºç§å­æ•°æ®
**æ–‡ä»¶**: `scripts/seed-data.js`

**é€»è¾‘**:
```javascript
// æ’å…¥ç¤ºä¾‹åŸŸåé…ç½®
await Domain.create({
  host: 'blaze.com',
  appName: 'Zona Live',
  email: 'support@blaze.com',
  status: 'active'
})

// æ’å…¥ç¤ºä¾‹è·¯ç”±è§„åˆ™
await RouteRule.create({
  pattern: '/proto/child-safety-*',
  type: 'wildcard',
  domain: 'blaze.com',
  templateId: '...',  // å®šåˆ¶æ¨¡æ¿ ID
  priority: 10,
  enabled: true
})
```

**é¢„æœŸç»“æœ**: æ–°ç¯å¢ƒå¯å¿«é€Ÿå¯åŠ¨

---

### é˜¶æ®µ 7ï¼šæµ‹è¯•ä¸æ–‡æ¡£ï¼ˆ30 åˆ†é’Ÿï¼‰

#### 7.1 åŠŸèƒ½æµ‹è¯•
**æµ‹è¯•ç”¨ä¾‹**:

1. **å¤åˆ¶æ¨¡æ¿æµç¨‹**
   - è®¿é—® `/admin/templates.html`
   - ç‚¹å‡»å…¬å…±æ¨¡æ¿çš„"å¤åˆ¶"æŒ‰é’®
   - å¡«å†™åç§°ã€åŸŸåã€å˜é‡
   - æäº¤åæ£€æŸ¥æ•°æ®åº“

2. **ç»‘å®šè·¯ç”±æµç¨‹**
   - è®¿é—® `/admin/routes.html`
   - åˆ›å»ºè·¯ç”±è§„åˆ™ `/proto/child-safety-*` â†’ å®šåˆ¶æ¨¡æ¿
   - ä¿å­˜åæ£€æŸ¥æ•°æ®åº“

3. **å‰å°éªŒè¯**
   - è®¾ç½® `TEST_HOST=blaze.com`
   - è®¿é—® `http://localhost/proto/child-safety-test`
   - éªŒè¯æ¸²æŸ“çš„æ¨¡æ¿å†…å®¹

4. **ç¼“å­˜éªŒè¯**
   - ç¬¬ä¸€æ¬¡è®¿é—®è®°å½•å“åº”æ—¶é—´
   - ç¬¬äºŒæ¬¡è®¿é—®éªŒè¯ç¼“å­˜å‘½ä¸­ï¼ˆå“åº”æ—¶é—´ < 10msï¼‰
   - ä¿®æ”¹æ¨¡æ¿å†…å®¹ï¼ŒéªŒè¯ç¼“å­˜æ¸…é™¤

**é¢„æœŸç»“æœ**: æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸

---

#### 7.2 æ›´æ–° CLAUDE.md
**æ–‡ä»¶**: `CLAUDE.md`

**æ·»åŠ å†…å®¹**:

```markdown
## æ¨¡æ¿é…ç½®ç®¡ç†ç³»ç»Ÿ

### æ¶æ„è®¾è®¡
- **æ•°æ®åº“**: MongoDBï¼ˆDocker Compose éƒ¨ç½²ï¼‰
- **æ¨¡æ¿å¼•æ“**: åŠ¨æ€è·¯ç”±è§£æ + å˜é‡æ¸²æŸ“
- **ç¼“å­˜ç­–ç•¥**: å†…å­˜ç¼“å­˜ï¼ˆTTL 300sï¼‰

### æ ¸å¿ƒç»„ä»¶
- `src/models/*` - MongoDB æ•°æ®æ¨¡å‹
- `src/services/template-resolver.js` - æ¨¡æ¿è§£æå¼•æ“
- `admin/*` - ç®¡ç†åå°ç•Œé¢

### å¼€å‘å‘½ä»¤
```bash
# å¯åŠ¨ MongoDB
docker-compose up -d

# åˆå§‹åŒ–æ•°æ®åº“
node scripts/init-db.js

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
yarn serve

# è®¿é—®ç®¡ç†åå°
open http://localhost/admin
```

### ç®¡ç†åå°
- æ¨¡æ¿ç®¡ç†: `/admin/templates.html`
- è·¯ç”±ç®¡ç†: `/admin/routes.html`
- åŸŸåç®¡ç†: `/admin/domains.html`
- Mongo Express: `http://localhost:8081` (admin/admin123)
```

**é¢„æœŸç»“æœ**: æ–‡æ¡£å®Œå–„

---

#### 7.3 æ›´æ–° README
**æ–‡ä»¶**: `README.md`

**æ·»åŠ å†…å®¹**:

```markdown
## æ¨¡æ¿é…ç½®ç®¡ç†

### å¯åŠ¨ MongoDB
```bash
docker-compose up -d
```

### åˆå§‹åŒ–æ•°æ®
```bash
node scripts/init-db.js
```

### è®¿é—®ç®¡ç†åå°
- æ¨¡æ¿ç®¡ç†: http://localhost/admin/templates.html
- è·¯ç”±ç®¡ç†: http://localhost/admin/routes.html
- æ•°æ®åº“ç®¡ç†: http://localhost:8081 (admin/admin123)

### å¿«é€Ÿä¸Šæ‰‹
1. å¤åˆ¶å…¬å…±æ¨¡æ¿åˆ›å»ºå®šåˆ¶ç‰ˆæœ¬
2. é…ç½®è·¯ç”±è§„åˆ™ç»‘å®šæ¨¡æ¿
3. è®¿é—®å‰å°é¡µé¢éªŒè¯
```

**é¢„æœŸç»“æœ**: ç”¨æˆ·å¯å¿«é€Ÿä¸Šæ‰‹

---

## ğŸ“‚ æœ€ç»ˆç›®å½•ç»“æ„

```
project/
â”œâ”€â”€ docker-compose.yml           # MongoDB + Mongo Express
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ init-db.js              # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ seed-data.js            # ç§å­æ•°æ®
â”‚   â””â”€â”€ docker-run.sh
â”œâ”€â”€ admin/                       # ç®¡ç†åå°å‰ç«¯
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ templates.html
â”‚   â”œâ”€â”€ routes.html
â”‚   â””â”€â”€ domains.html
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ models/                  # MongoDB æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ BaseTemplate.js
â”‚   â”‚   â”œâ”€â”€ CustomTemplate.js
â”‚   â”‚   â”œâ”€â”€ RouteRule.js
â”‚   â”‚   â””â”€â”€ Domain.js
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ mongo.js            # MongoDB è¿æ¥
â”‚   â”‚   â”œâ”€â”€ cache.js            # ç¼“å­˜æœåŠ¡
â”‚   â”‚   â””â”€â”€ template-resolver.js # æ¨¡æ¿è§£æå¼•æ“
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ admin/              # ç®¡ç†åå° API
â”‚   â”‚   â”‚   â”œâ”€â”€ templates.js
â”‚   â”‚   â”‚   â”œâ”€â”€ routes.js
â”‚   â”‚   â”‚   â””â”€â”€ domains.js
â”‚   â”‚   â””â”€â”€ proto/
â”‚   â”‚       â””â”€â”€ index.js        # å‰å°è·¯ç”±ï¼ˆæ”¹é€ ï¼‰
â”‚   â””â”€â”€ index.js                # ä¸»å…¥å£ï¼ˆé›†æˆ MongoDBï¼‰
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ base/                    # å…¬å…±æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ child-safety.html
â”‚   â”‚   â”œâ”€â”€ privacy-policy.html
â”‚   â”‚   â””â”€â”€ destroy-account.html
â”‚   â””â”€â”€ custom/                  # å®šåˆ¶æ¨¡æ¿å¤‡ä»½
â”œâ”€â”€ .env.example
â”œâ”€â”€ CLAUDE.md                    # æ›´æ–°æ¶æ„è¯´æ˜
â””â”€â”€ README.md                    # æ›´æ–°ä½¿ç”¨æŒ‡å—
```

---

## ğŸ“¦ ä¾èµ–åŒ…æ¸…å•

```json
{
  "dependencies": {
    "mongoose": "^8.0.0",
    "js-yaml": "^4.1.0"
  }
}
```

---

## â±ï¸ æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | æ—¶é—´ | ç´¯è®¡ |
|------|------|------|
| é˜¶æ®µ 1ï¼šåŸºç¡€è®¾æ–½å‡†å¤‡ | 30 åˆ†é’Ÿ | 30 åˆ†é’Ÿ |
| é˜¶æ®µ 2ï¼šæ•°æ®æ¨¡å‹ä¸æœåŠ¡å±‚ | 1 å°æ—¶ | 1.5 å°æ—¶ |
| é˜¶æ®µ 3ï¼šç®¡ç†åå° API | 1 å°æ—¶ | 2.5 å°æ—¶ |
| é˜¶æ®µ 4ï¼šå‰å°è·¯ç”±æ”¹é€  | 30 åˆ†é’Ÿ | 3 å°æ—¶ |
| é˜¶æ®µ 5ï¼šç®¡ç†åå°å‰ç«¯ | 1.5 å°æ—¶ | 4.5 å°æ—¶ |
| é˜¶æ®µ 6ï¼šæ•°æ®è¿ç§»ä¸åˆå§‹åŒ– | 30 åˆ†é’Ÿ | 5 å°æ—¶ |
| é˜¶æ®µ 7ï¼šæµ‹è¯•ä¸æ–‡æ¡£ | 30 åˆ†é’Ÿ | **5.5 å°æ—¶** |

---

## âœ… éªŒæ”¶æ ‡å‡†

### é‡Œç¨‹ç¢‘ 1ï¼šåŸºç¡€è®¾æ–½å®Œæˆ
- âœ… Docker Compose å¯åŠ¨ MongoDB æˆåŠŸ
- âœ… åº”ç”¨å¯è¿æ¥ MongoDB
- âœ… Mongoose æ¨¡å‹å®šä¹‰å®Œæˆ

### é‡Œç¨‹ç¢‘ 2ï¼šæ ¸å¿ƒåŠŸèƒ½å®Œæˆ
- âœ… å¯é€šè¿‡ API å¤åˆ¶æ¨¡æ¿
- âœ… å¯é€šè¿‡ API ç»‘å®šè·¯ç”±
- âœ… å‰å°é¡µé¢å¯æ­£ç¡®æ¸²æŸ“åŠ¨æ€æ¨¡æ¿
- âœ… ç¼“å­˜æœºåˆ¶æ­£å¸¸å·¥ä½œ

### é‡Œç¨‹ç¢‘ 3ï¼šç®¡ç†åå°å®Œæˆ
- âœ… å¯è§†åŒ–ç®¡ç†æ¨¡æ¿ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
- âœ… å¯è§†åŒ–é…ç½®è·¯ç”±ï¼ˆæ”¯æŒæ³›åŒ¹é…ï¼‰
- âœ… é…ç½®å®æ—¶ç”Ÿæ•ˆï¼ˆç¼“å­˜è‡ªåŠ¨æ¸…é™¤ï¼‰

### é‡Œç¨‹ç¢‘ 4ï¼šç”Ÿäº§å°±ç»ª
- âœ… æ•°æ®è¿ç§»å®Œæˆï¼ˆç°æœ‰æ¨¡æ¿å¯¼å…¥ï¼‰
- âœ… å…¼å®¹æ€§å¤„ç†ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
- âœ… æ–‡æ¡£å®Œå–„ï¼ˆCLAUDE.md + READMEï¼‰
- âœ… æµ‹è¯•é€šè¿‡ï¼ˆæ ¸å¿ƒæµç¨‹éªŒè¯ï¼‰

---

## ğŸ¯ å…³é”®å†³ç­–

### ä¸ºä»€ä¹ˆé€‰æ‹© MongoDBï¼Ÿ
1. âœ… **Schema çµæ´»**ï¼šæ¨¡æ¿å­—æ®µæ˜“æ‰©å±•
2. âœ… **åµŒå¥—æ•°æ®**ï¼švariables ä½¿ç”¨ Map ç±»å‹
3. âœ… **æŸ¥è¯¢æ€§èƒ½**ï¼šå¤åˆç´¢å¼•ä¼˜åŒ–è·¯ç”±åŒ¹é…
4. âœ… **JSON å…¼å®¹**ï¼šå‰åç«¯æ•°æ®äº¤äº’è‡ªç„¶

### ä¸ºä»€ä¹ˆä½¿ç”¨å†…å­˜ç¼“å­˜è€Œé Redisï¼Ÿ
1. âœ… **ç®€å•éƒ¨ç½²**ï¼šæ— éœ€é¢å¤–æœåŠ¡
2. âœ… **æ€§èƒ½å……è¶³**ï¼šå•æœºåœºæ™¯è¶³å¤Ÿ
3. âœ… **æ˜“äºæ‰©å±•**ï¼šåç»­å¯æ¥å…¥ Redis

### ä¸ºä»€ä¹ˆä¿ç•™æ–‡ä»¶å¤‡ä»½ï¼Ÿ
1. âœ… **é™çº§æ–¹æ¡ˆ**ï¼šæ•°æ®åº“æŒ‚æ‰æ—¶å¯è¯»æ–‡ä»¶
2. âœ… **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ–‡ä»¶å¯ Git ç®¡ç†
3. âœ… **å¿«é€Ÿæ¢å¤**ï¼šè¯¯åˆ å¯ä»æ–‡ä»¶æ¢å¤

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### å¼€å‘é˜¶æ®µ
1. **æ•°æ®åº“å¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½ MongoDB æ•°æ®
2. **ç¼“å­˜æ¸…ç†**ï¼šä¿®æ”¹æ¨¡æ¿åæ‰‹åŠ¨æ¸…é™¤ç¼“å­˜
3. **è·¯ç”±ä¼˜å…ˆçº§**ï¼šæ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆï¼Œæ³¨æ„å†²çª

### ç”Ÿäº§éƒ¨ç½²
1. **MongoDB æŒä¹…åŒ–**ï¼šä½¿ç”¨ Docker Volume æŒä¹…åŒ–æ•°æ®
2. **æƒé™æ§åˆ¶**ï¼šç®¡ç†åå°æ·»åŠ è®¤è¯ä¸­é—´ä»¶
3. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§ç¼“å­˜å‘½ä¸­ç‡ã€æ•°æ®åº“æŸ¥è¯¢æ—¶é—´

---

## ğŸš€ æ‰§è¡Œæ–¹å¼

### æ¨èï¼šåˆ†é˜¶æ®µå®ç°
1. **ç¬¬ä¸€é˜¶æ®µ**ï¼ˆ1.5 å°æ—¶ï¼‰ï¼šåŸºç¡€è®¾æ–½ + æ•°æ®æ¨¡å‹ + æ ¸å¿ƒæœåŠ¡
2. **ç¬¬äºŒé˜¶æ®µ**ï¼ˆ1 å°æ—¶ï¼‰ï¼šç®¡ç†åå° API
3. **ç¬¬ä¸‰é˜¶æ®µ**ï¼ˆ2 å°æ—¶ï¼‰ï¼šå‰å°æ”¹é€  + ç®¡ç†ç•Œé¢
4. **ç¬¬å››é˜¶æ®µ**ï¼ˆ1 å°æ—¶ï¼‰ï¼šæ•°æ®è¿ç§» + æµ‹è¯•æ–‡æ¡£

æ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œç­‰å¾…åé¦ˆå†ç»§ç»­ã€‚

---

## ğŸ“… åˆ›å»ºæ—¶é—´
2025-12-07

## ğŸ“Œ ä»»åŠ¡çŠ¶æ€
- [x] éœ€æ±‚åˆ†æ
- [x] æ–¹æ¡ˆè®¾è®¡
- [x] è®¡åˆ’åˆ¶å®š
- [ ] ä»£ç å®ç°
- [ ] ä»£ç ä¼˜åŒ–
- [ ] è´¨é‡è¯„å®¡
