# Webbox Monorepo æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“ æ•´ä½“æ¶æ„

æœ¬é¡¹ç›®é‡‡ç”¨ Monorepo æ¶æ„ï¼Œä½¿ç”¨ npm workspaces è¿›è¡ŒåŒ…ç®¡ç†ï¼Œå®ç°ä¸‰ä¸ªç‹¬ç«‹æœåŠ¡å’Œä¸€ä¸ªå…±äº«ä»£ç åŒ…çš„ç»Ÿä¸€ç®¡ç†ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Webbox Monorepo                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Render     â”‚  â”‚     API      â”‚  â”‚    Admin     â”‚     â”‚
â”‚  â”‚   Service    â”‚  â”‚   Service    â”‚  â”‚   Service    â”‚     â”‚
â”‚  â”‚  (Port 3001) â”‚  â”‚ (Port 3002)  â”‚  â”‚ (Port 3003)  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                 â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â”‚                                 â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                  â”‚  Shared Package â”‚                        â”‚
â”‚                  â”‚ Models/Env/Utilsâ”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                           â”‚                                 â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                  â”‚    MongoDB      â”‚                        â”‚
â”‚                  â”‚  (Port 27017)   â”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ›ï¸ æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. DRY (Don't Repeat Yourself)
- **å…±äº«ä»£ç åŒ…**ï¼šæ‰€æœ‰æœåŠ¡å…±ç”¨ç›¸åŒçš„æ•°æ®æ¨¡å‹ã€ç¯å¢ƒé…ç½®å’Œå·¥å…·å‡½æ•°
- **å•ä¸€æ•°æ®æº**ï¼šMongoDB schemas å®šä¹‰åœ¨ shared åŒ…ä¸­ï¼Œé¿å…é‡å¤å®šä¹‰

### 2. å…³æ³¨ç‚¹åˆ†ç¦» (Separation of Concerns)
- **æ¸²æŸ“æœåŠ¡**ï¼šä¸“æ³¨äºæ¨¡æ¿æ¸²æŸ“å’Œå†…å®¹å±•ç¤º
- **API æœåŠ¡**ï¼šä¸“æ³¨äºæ•°æ®æ“ä½œå’Œä¸šåŠ¡é€»è¾‘
- **Admin æœåŠ¡**ï¼šä¸“æ³¨äºç”¨æˆ·ç•Œé¢å’Œäº¤äº’

### 3. å¾®æœåŠ¡æ¶æ„
- æ¯ä¸ªæœåŠ¡å¯**ç‹¬ç«‹éƒ¨ç½²**
- æœåŠ¡é—´é€šè¿‡ HTTP API é€šä¿¡
- æ”¯æŒ**ç‹¬ç«‹æ‰©å±•**å’Œ**è´Ÿè½½å‡è¡¡**

## ğŸ“¦ Package è®¾è®¡

### Shared Package (å…±äº«ä»£ç åŒ…)

```typescript
packages/shared/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ models/              # Mongoose æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ basetemplate.model.ts
â”‚   â”‚   â”œâ”€â”€ customtemplate.model.ts
â”‚   â”‚   â”œâ”€â”€ domain.model.ts
â”‚   â”‚   â”œâ”€â”€ routerule.model.ts
â”‚   â”‚   â””â”€â”€ user.model.ts
â”‚   â”œâ”€â”€ env/                 # ç¯å¢ƒå˜é‡é…ç½®
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ db.ts           # æ•°æ®åº“è¿æ¥ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ uuid.ts         # UUID ç”Ÿæˆå™¨
â”‚   â”‚   â””â”€â”€ datetime.ts     # æ—¥æœŸæ—¶é—´å·¥å…·
â”‚   â””â”€â”€ index.ts             # ç»Ÿä¸€å¯¼å‡º
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä»ç°æœ‰é¡¹ç›® `~/panda/webbox-admin-api` å¯¼å…¥å¹¶è½¬æ¢ä¸º TypeScript
- âœ… ä¿ç•™æ‰€æœ‰åŸæœ‰åŠŸèƒ½ï¼ˆUUIDã€æ—¥æœŸæ ¼å¼åŒ–ã€å¯†ç åŠ å¯†ç­‰ï¼‰
- âœ… ä½¿ç”¨ Zod è¿›è¡Œç¯å¢ƒå˜é‡éªŒè¯
- âœ… å•ä¾‹æ¨¡å¼ç®¡ç†æ•°æ®åº“è¿æ¥

### Render Service (æ¸²æŸ“æœåŠ¡)

```typescript
packages/render-service/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ template.service.ts  # æ¨¡æ¿æœåŠ¡
â”‚   â””â”€â”€ index.ts                  # Express åº”ç”¨
```

**èŒè´£**ï¼š
1. æ¥æ”¶ `host + path` è¯·æ±‚
2. æŸ¥è¯¢æ•°æ®åº“è·å–åŸŸåé…ç½®
3. åŒ¹é…è·¯ç”±è§„åˆ™æ‰¾åˆ°å¯¹åº”æ¨¡æ¿
4. ä½¿ç”¨ Mustache æ¸²æŸ“ HTML
5. è¿”å›æ¸²æŸ“ç»“æœ

**æŠ€æœ¯æ ˆ**ï¼š
- Express 4
- Mongoose 8
- Mustache 4
- TypeScript 5

**API ç«¯ç‚¹**ï¼š
- `GET /health` - å¥åº·æ£€æŸ¥
- `GET /render?host=xxx&path=xxx` - æ¸²æŸ“æ¨¡æ¿
- `GET /template-info?host=xxx&path=xxx` - è·å–æ¨¡æ¿ä¿¡æ¯
- `GET /demo` - æ¼”ç¤ºé¡µé¢

### API Service (API æœåŠ¡)

```typescript
packages/api-service/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ template.controller.ts
â”‚   â”‚   â””â”€â”€ auth.controller.ts
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ template.routes.ts
â”‚   â”‚   â””â”€â”€ auth.routes.ts
â”‚   â””â”€â”€ index.ts
```

**èŒè´£**ï¼š
1. æä¾› RESTful API æ“ä½œæ•°æ®åº“
2. ç”¨æˆ·è®¤è¯å’Œæˆæƒ
3. æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†

**æŠ€æœ¯æ ˆ**ï¼š
- Express 4
- Mongoose 8
- bcrypt (å¯†ç åŠ å¯†)
- jsonwebtoken (JWT)
- TypeScript 5

**API ç«¯ç‚¹**ï¼š
- `GET /health` - å¥åº·æ£€æŸ¥
- `POST /api/auth/login` - ç”¨æˆ·ç™»å½•
- `POST /api/auth/users` - åˆ›å»ºç”¨æˆ·
- `GET /api/templates` - è·å–æ‰€æœ‰æ¨¡æ¿
- `GET /api/templates/query` - æŸ¥è¯¢æ¨¡æ¿
- `POST /api/templates` - åˆ›å»ºæ¨¡æ¿
- `PUT /api/templates/:id` - æ›´æ–°æ¨¡æ¿
- `DELETE /api/templates/:id` - åˆ é™¤æ¨¡æ¿

### Admin Service (ç®¡ç†åå°)

```typescript
packages/admin-service/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ app/
â”‚       â”œâ”€â”€ layout.tsx      # å¸ƒå±€ç»„ä»¶
â”‚       â””â”€â”€ page.tsx        # ç™»å½•é¡µé¢
```

**èŒè´£**ï¼š
1. æä¾›ç®¡ç†ç•Œé¢
2. è°ƒç”¨ API æœåŠ¡è¿›è¡Œæ•°æ®æ“ä½œ
3. ç”¨æˆ·è®¤è¯å’Œä¼šè¯ç®¡ç†

**æŠ€æœ¯æ ˆ**ï¼š
- Next.js 16 (App Router)
- React 19
- TypeScript 5

**é¡µé¢**ï¼š
- `/` - ç™»å½•é¡µé¢
- `/dashboard` - ç®¡ç†ä»ªè¡¨ç›˜ (å¾…å®ç°)

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹è®¾è®¡

### æ•°æ®åº“ ERD

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BaseTemplateâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”‚ CustomTemplate  â”‚
â”‚              â”‚   ref   â”‚                  â”‚
â”‚  - name      â”‚         â”‚  - name          â”‚
â”‚  - category  â”‚         â”‚  - domain        â”‚
â”‚  - content   â”‚         â”‚  - content       â”‚
â”‚  - variables â”‚         â”‚  - variables     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ ref
                                  â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   RouteRule      â”‚
                         â”‚                  â”‚
                         â”‚  - pattern       â”‚
                         â”‚  - type          â”‚
                         â”‚  - domain        â”‚
                         â”‚  - priority      â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Domain    â”‚
â”‚              â”‚
â”‚  - domain    â”‚
â”‚  - app_name  â”‚
â”‚  - email     â”‚
â”‚  - config    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     User     â”‚
â”‚              â”‚
â”‚  - username  â”‚
â”‚  - email     â”‚
â”‚  - password  â”‚
â”‚  - role      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµç¨‹

#### æ¸²æŸ“æµç¨‹
```
ç”¨æˆ·è¯·æ±‚
  â†“
GET /render?host=example.com&path=/page1
  â†“
æ¸²æŸ“æœåŠ¡
  â†“
1. æŸ¥è¯¢ Domain (example.com)
  â†“
2. åŒ¹é… RouteRule (/page1)
  â†“
3. è·å– CustomTemplate
  â†“
4. ä½¿ç”¨ Mustache æ¸²æŸ“
  â†“
è¿”å› HTML
```

#### ç®¡ç†æµç¨‹
```
ç®¡ç†å‘˜ç™»å½•
  â†“
POST /api/auth/login
  â†“
API æœåŠ¡éªŒè¯
  â†“
è¿”å› JWT Token
  â†“
æºå¸¦ Token è®¿é—®ç®¡ç†åŠŸèƒ½
  â†“
è°ƒç”¨ API æœåŠ¡æ“ä½œæ•°æ®
```

## ğŸ³ Docker éƒ¨ç½²æ¶æ„

### Docker Compose æœåŠ¡ç¼–æ’

```yaml
services:
  mongodb:        # æ•°æ®åº“
  api-service:    # API æœåŠ¡ (ä¾èµ– mongodb)
  render-service: # æ¸²æŸ“æœåŠ¡ (ä¾èµ– mongodb)
  admin-service:  # Admin æœåŠ¡ (ä¾èµ– api-service)
```

### ç½‘ç»œæ‹“æ‰‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         webbox-network (bridge)          â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Render â”‚  â”‚  API   â”‚  â”‚ Admin  â”‚    â”‚
â”‚  â”‚:3001   â”‚  â”‚:3002   â”‚  â”‚:3003   â”‚    â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â”‚
â”‚      â”‚           â”‚           â”‚          â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                  â”‚                      â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                â”‚
â”‚            â”‚  MongoDB  â”‚                â”‚
â”‚            â”‚   :27017  â”‚                â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚       â”‚        â”‚
         â–¼       â–¼        â–¼
    Host Ports: 3001, 3002, 3003, 27017
```

## ğŸ”§ å¼€å‘å’Œéƒ¨ç½²

### æœ¬åœ°å¼€å‘æ¨¡å¼

1. **Workspace ä¾èµ–å®‰è£…**ï¼š`npm install` åœ¨æ ¹ç›®å½•å®‰è£…æ‰€æœ‰ä¾èµ–
2. **æœåŠ¡ç‹¬ç«‹å¯åŠ¨**ï¼š
   - `npm run dev:api` - API æœåŠ¡
   - `npm run dev:render` - æ¸²æŸ“æœåŠ¡
   - `npm run dev:admin` - Admin æœåŠ¡
3. **çƒ­é‡è½½**ï¼šä½¿ç”¨ tsx æˆ– Next.js dev server å®ç°ä»£ç çƒ­æ›´æ–°

### Docker éƒ¨ç½²æ¨¡å¼

1. **å¤šé˜¶æ®µæ„å»º**ï¼š
   - deps é˜¶æ®µï¼šå®‰è£…ä¾èµ–
   - builder é˜¶æ®µï¼šæ„å»ºä»£ç 
   - runner é˜¶æ®µï¼šè¿è¡Œåº”ç”¨
2. **æœ€å°åŒ–é•œåƒ**ï¼šä½¿ç”¨ alpine åŸºç¡€é•œåƒ
3. **ç»Ÿä¸€ç¼–æ’**ï¼šdocker-compose ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡

## ğŸ“Š æ‰©å±•æ€§è®¾è®¡

### æ°´å¹³æ‰©å±•

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Load Balancerâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ Render  â”‚       â”‚ Render   â”‚      â”‚ Render   â”‚
   â”‚ Service â”‚       â”‚ Service  â”‚      â”‚ Service  â”‚
   â”‚ Instanceâ”‚       â”‚ Instance â”‚      â”‚ Instance â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‚ç›´æ‰©å±•

- MongoDB åˆ†ç‰‡
- Redis ç¼“å­˜å±‚
- CDN åŠ é€Ÿé™æ€èµ„æº

## ğŸ”’ å®‰å…¨è®¾è®¡

1. **è®¤è¯**ï¼šJWT Token è®¤è¯
2. **å¯†ç **ï¼šbcrypt åŠ å¯†å­˜å‚¨
3. **CORS**ï¼šé…ç½®è·¨åŸŸè®¿é—®æ§åˆ¶
4. **Helmet**ï¼šè®¾ç½®å®‰å…¨ HTTP å¤´
5. **ç¯å¢ƒå˜é‡**ï¼šæ•æ„Ÿä¿¡æ¯ä¸æäº¤ä»£ç åº“

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **æ•°æ®åº“ç´¢å¼•**ï¼šä¸ºé«˜é¢‘æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
2. **è¿æ¥æ± **ï¼šMongoose è¿æ¥æ± ç®¡ç†
3. **ç¼“å­˜ç­–ç•¥**ï¼šå¯æ‰©å±• Redis ç¼“å­˜
4. **é™æ€èµ„æº**ï¼šå¯æ¥å…¥ CDN

## ğŸ§ª æµ‹è¯•ç­–ç•¥

1. **å•å…ƒæµ‹è¯•**ï¼šæµ‹è¯•ç‹¬ç«‹å‡½æ•°å’Œæ¨¡å—
2. **é›†æˆæµ‹è¯•**ï¼šæµ‹è¯•æœåŠ¡é—´äº¤äº’
3. **E2E æµ‹è¯•**ï¼šæµ‹è¯•å®Œæ•´ä¸šåŠ¡æµç¨‹
4. **æ€§èƒ½æµ‹è¯•**ï¼šå‹åŠ›æµ‹è¯•å’Œæ€§èƒ½åŸºå‡†

## ğŸ“ æœªæ¥è§„åˆ’

1. **ç›‘æ§å‘Šè­¦**ï¼šé›†æˆ Prometheus + Grafana
2. **æ—¥å¿—ç³»ç»Ÿ**ï¼šELK æˆ– Loki æ—¥å¿—èšåˆ
3. **API æ–‡æ¡£**ï¼šSwagger/OpenAPI è§„èŒƒ
4. **CI/CD**ï¼šGitHub Actions è‡ªåŠ¨åŒ–éƒ¨ç½²
5. **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šRabbitMQ/Kafka å¼‚æ­¥å¤„ç†

---

æ–‡æ¡£ç‰ˆæœ¬: 1.0
æœ€åæ›´æ–°: 2024-12-11
