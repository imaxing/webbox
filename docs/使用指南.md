# Webbox é¡¹ç›®ä½¿ç”¨æŒ‡å—

## ğŸ“¦ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº **Monorepo** æ¶æ„çš„ Next.js å¤šæœåŠ¡é¡¹ç›®ï¼ŒåŒ…å«ä¸‰ä¸ªç‹¬ç«‹æœåŠ¡ï¼š

1. **æ¸²æŸ“æœåŠ¡ (Render Service)** - ç«¯å£ 3001
   - æ ¹æ® host + path ä»æ•°æ®åº“è¯»å–æ¨¡æ¿å’Œå˜é‡
   - ä½¿ç”¨ Mustache æ¸²æŸ“ HTML å¹¶è¿”å›

2. **API æœåŠ¡ (API Service)** - ç«¯å£ 3002
   - æä¾› RESTful API æ“ä½œæ•°æ®åº“
   - JWT è®¤è¯ã€ç”¨æˆ·ç®¡ç†ã€æ¨¡æ¿ç®¡ç†ã€åŸŸåç®¡ç†ç­‰

3. **Admin æœåŠ¡ (Admin Service)** - ç«¯å£ 3003
   - Next.js ç®¡ç†åå°
   - è°ƒç”¨ API æœåŠ¡è¿›è¡Œæ•°æ®æ“ä½œ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿å·²å®‰è£…ï¼š
- **Node.js** >= 18
- **MongoDB** æ•°æ®åº“
- **npm** åŒ…ç®¡ç†å™¨

### 2. å¯åŠ¨ MongoDB

```bash
# ä½¿ç”¨ Homebrew å¯åŠ¨
brew services start mongodb-community

# æˆ–è€…æ‰‹åŠ¨å¯åŠ¨
mongod --config /usr/local/etc/mongod.conf
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶ï¼š

```bash
# MongoDB é…ç½®ï¼ˆæ”¯æŒè®¤è¯ï¼‰
MONGODB_URI=mongodb://localhost:27017/webbox
# æˆ–å¸¦è®¤è¯: mongodb://username:password@localhost:27017/webbox?authSource=admin

# JWT å¯†é’¥
JWT_SECRET=your-secret-key-change-in-production

# ç¯å¢ƒ
NODE_ENV=development
```

### 4. ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™ï¼ˆé¦–æ¬¡éœ€è¦ï¼‰
chmod +x start-all.sh stop-all.sh

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./start-all.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
- âœ… æ£€æŸ¥ MongoDB çŠ¶æ€
- âœ… å®‰è£…é¡¹ç›®ä¾èµ–
- âœ… æ„å»ºå…±äº«åŒ…
- âœ… å¯åŠ¨ä¸‰ä¸ªæœåŠ¡
- âœ… å¥åº·æ£€æŸ¥

### 5. åœæ­¢æ‰€æœ‰æœåŠ¡

```bash
./stop-all.sh
```

## ğŸ“‹ æœåŠ¡ç«¯ç‚¹

### æ¸²æŸ“æœåŠ¡ (ç«¯å£ 3001)
- **å¥åº·æ£€æŸ¥**: http://localhost:3001/health
- **Demo é¡µé¢**: http://localhost:3001/demo
- **æ¸²æŸ“æ¥å£**: http://localhost:3001/render?host=xxx&path=xxx
- **æ¨¡æ¿ä¿¡æ¯**: http://localhost:3001/template-info?host=xxx&path=xxx

### API æœåŠ¡ (ç«¯å£ 3002)
- **å¥åº·æ£€æŸ¥**: http://localhost:3002/health
- **API æ–‡æ¡£**: http://localhost:3002/api-docs
- **ç”¨æˆ·ç™»å½•**: POST http://localhost:3002/api/auth/login
- **åˆ›å»ºç”¨æˆ·**: POST http://localhost:3002/api/auth/users
- **ç®¡ç†æ¥å£**: http://localhost:3002/api/admin/*

### Admin æœåŠ¡ (ç«¯å£ 3003)
- **ç®¡ç†åå°**: http://localhost:3003

### æµ‹è¯•é¡µé¢
- **æœ¬åœ°æ–‡ä»¶**: `public/index.html` ï¼ˆåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼‰

## ğŸ§ª å¿«é€Ÿæµ‹è¯•

### 1. åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·

```bash
curl -X POST http://localhost:3002/api/auth/users \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123",
    "email": "admin@example.com",
    "role": "admin"
  }'
```

### 2. ç™»å½•è·å– Token

```bash
curl -X POST http://localhost:3002/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'
```

è¿”å›ç¤ºä¾‹ï¼š
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "...",
      "username": "admin",
      "role": "admin"
    }
  }
}
```

### 3. ä½¿ç”¨ Token è®¿é—®ç®¡ç†æ¥å£

```bash
# è·å–æ‰€æœ‰åŸŸå
curl http://localhost:3002/api/admin/domains \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"

# è·å–æ‰€æœ‰æ¨¡æ¿
curl http://localhost:3002/api/admin/base-templates \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
webbox-nextjs/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ shared/              # å…±äº«ä»£ç åŒ…
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ models/      # Mongoose æ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ utils/       # å·¥å…·ç±»ï¼ˆDBã€Responseã€CrudControllerï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ env/         # ç¯å¢ƒå˜é‡é…ç½®
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ render-service/      # æ¸²æŸ“æœåŠ¡ï¼ˆç«¯å£ 3001ï¼‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ services/    # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚   â””â”€â”€ index.ts     # æœåŠ¡å…¥å£
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ api-service/         # API æœåŠ¡ï¼ˆç«¯å£ 3002ï¼‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ routes/      # è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware/  # ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ index.ts     # æœåŠ¡å…¥å£
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ admin-service/       # Admin æœåŠ¡ï¼ˆç«¯å£ 3003ï¼‰
â”‚       â”œâ”€â”€ app/             # Next.js App Router
â”‚       â”œâ”€â”€ Dockerfile
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ docs/                    # æ–‡æ¡£
â”‚   â”œâ”€â”€ é¡¹ç›®æ¶æ„.md
â”‚   â”œâ”€â”€ APIæ–‡æ¡£.md
â”‚   â””â”€â”€ ä½¿ç”¨æŒ‡å—.md
â”‚
â”œâ”€â”€ public/                  # é™æ€æ–‡ä»¶
â”‚   â””â”€â”€ index.html          # æµ‹è¯•é¡µé¢
â”‚
â”œâ”€â”€ logs/                    # æœåŠ¡æ—¥å¿—ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”‚   â”œâ”€â”€ api-service.log
â”‚   â”œâ”€â”€ render-service.log
â”‚   â””â”€â”€ admin-service.log
â”‚
â”œâ”€â”€ .env                     # ç¯å¢ƒå˜é‡
â”œâ”€â”€ docker-compose.yml       # Docker ç¼–æ’
â”œâ”€â”€ start-all.sh            # ä¸€é”®å¯åŠ¨è„šæœ¬
â””â”€â”€ stop-all.sh             # ä¸€é”®åœæ­¢è„šæœ¬
```

## ğŸ”§ å¼€å‘æ¨¡å¼

### å•ç‹¬å¯åŠ¨æŸä¸ªæœåŠ¡

```bash
# å¯åŠ¨ API æœåŠ¡
cd packages/api-service
npm run dev

# å¯åŠ¨æ¸²æŸ“æœåŠ¡
cd packages/render-service
npm run dev

# å¯åŠ¨ Admin æœåŠ¡
cd packages/admin-service
npm run dev
```

### æŸ¥çœ‹æœåŠ¡æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
tail -f logs/*.log

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
tail -f logs/api-service.log
```

### é‡æ–°æ„å»ºå…±äº«åŒ…

```bash
cd packages/shared
npm run build
```

## ğŸ³ Docker éƒ¨ç½²

### ä½¿ç”¨ Docker Compose å¯åŠ¨

```bash
docker-compose up -d
```

### å•ç‹¬æ„å»ºæŸä¸ªæœåŠ¡

```bash
# æ„å»º API æœåŠ¡
cd packages/api-service
docker build -t webbox-api-service .

# æ„å»ºæ¸²æŸ“æœåŠ¡
cd packages/render-service
docker build -t webbox-render-service .

# æ„å»º Admin æœåŠ¡
cd packages/admin-service
docker build -t webbox-admin-service .
```

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. è·¯å¾„åˆ«åæ”¯æŒ
æ‰€æœ‰æœåŠ¡éƒ½æ”¯æŒä½¿ç”¨ `@/` å‰ç¼€å¯¼å…¥æœ¬åœ°æ¨¡å—ï¼š

```typescript
// âœ… æ¨èä½¿ç”¨è·¯å¾„åˆ«å
import { authMiddleware } from '@/middleware/auth';
import domainRoutes from '@/routes/admin/domain.routes';

// âŒ é¿å…ç›¸å¯¹è·¯å¾„
import { authMiddleware } from '../../middleware/auth';
```

### 2. é€šç”¨ CRUD æ§åˆ¶å™¨
æ‰€æœ‰æ¨¡å‹éƒ½æ”¯æŒå¼€ç®±å³ç”¨çš„ CRUD æ“ä½œï¼š

```typescript
import { CrudController, User } from '@webbox/shared';

const userCtrl = new CrudController(User);

router.get('/users', authMiddleware, (req, res) => userCtrl.list(req, res));
router.post('/users', authMiddleware, (req, res) => userCtrl.create(req, res));
```

æ”¯æŒçš„æŸ¥è¯¢å‚æ•°ï¼š
- `?page=1&limit=20` - åˆ†é¡µ
- `?sort=-createdAt` - æ’åºï¼ˆ-å·è¡¨ç¤ºé™åºï¼‰
- `?search=keyword` - æœç´¢
- ä»»æ„å­—æ®µè¿‡æ»¤

### 3. ç»Ÿä¸€å“åº”æ ¼å¼

```typescript
import { Response } from '@webbox/shared';

Response.success(res, data, 'æ“ä½œæˆåŠŸ');
Response.error(res, 'æ“ä½œå¤±è´¥');
Response.unauthorized(res);
Response.notFound(res, 'èµ„æºä¸å­˜åœ¨');
```

å“åº”æ ¼å¼ï¼š
```json
{
  "code": 200,
  "message": "æˆåŠŸ",
  "data": {}
}
```

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### MongoDB è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ MongoDB æ˜¯å¦è¿è¡Œ
brew services list | grep mongodb

# é‡å¯ MongoDB
brew services restart mongodb-community

# æ£€æŸ¥è¿æ¥é…ç½®
cat .env | grep MONGODB_URI
```

### ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
lsof -i :3001
lsof -i :3002
lsof -i :3003

# æ€æ­»å ç”¨è¿›ç¨‹
kill -9 <PID>
```

### æ¸…ç†æ‰€æœ‰è¿›ç¨‹

```bash
./stop-all.sh

# å¼ºåˆ¶æ¸…ç†
pkill -f "tsx.*webbox"
pkill -f "next.*webbox"
```

## ğŸ“ ç¼–ç¨‹è§„èŒƒ

é¡¹ç›®ä¸¥æ ¼éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

- **KISS**ï¼šä¿æŒä»£ç ç®€å•ç›´è§‚
- **DRY**ï¼šé¿å…é‡å¤ä»£ç ï¼Œä½¿ç”¨å…±äº«æ¨¡å—
- **YAGNI**ï¼šåªå®ç°å½“å‰éœ€è¦çš„åŠŸèƒ½
- **SOLID**ï¼šå•ä¸€èŒè´£ã€å¼€é—­åŸåˆ™ç­‰

### ä»£ç è§„èŒƒ
- âœ… ä½¿ç”¨ TypeScript ç±»å‹æ³¨è§£
- âœ… ä½¿ç”¨è·¯å¾„åˆ«å `@/` å¯¼å…¥
- âœ… ç»Ÿä¸€ä½¿ç”¨ Response å·¥å…·ç±»è¿”å›
- âœ… ä»£ç æ³¨é‡Šä¸ä»£ç åº“è¯­è¨€ä¿æŒä¸€è‡´ï¼ˆä¸­æ–‡ï¼‰
- âœ… æ‰€æœ‰å¼‚æ­¥æ“ä½œä½¿ç”¨ async/await

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®æ¶æ„](./é¡¹ç›®æ¶æ„.md)
- [API æ–‡æ¡£](./APIæ–‡æ¡£.md)
- [æ•°æ®æ¨¡å‹](./æ•°æ®æ¨¡å‹.md)

## ğŸ’¡ æç¤º

1. é¦–æ¬¡å¯åŠ¨å‰ç¡®ä¿ MongoDB å·²è¿è¡Œ
2. ä½¿ç”¨ `./start-all.sh` ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
3. æ‰“å¼€ `public/index.html` æŸ¥çœ‹æµ‹è¯•é¡µé¢
4. è®¿é—® http://localhost:3002/api-docs æŸ¥çœ‹å®Œæ•´ API æ–‡æ¡£
5. ç”Ÿäº§ç¯å¢ƒè®°å¾—ä¿®æ”¹ JWT_SECRET

---

**é¡¹ç›®çŠ¶æ€**: âœ… æ‰€æœ‰åŠŸèƒ½å·²å®ç°å¹¶æµ‹è¯•é€šè¿‡

**æŠ€æœ¯æ ˆ**: Next.js 16 + React 19 + TypeScript + Express + MongoDB + Mongoose + JWT
