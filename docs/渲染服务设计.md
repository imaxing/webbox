# æ¸²æŸ“æœåŠ¡è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æ¸²æŸ“æœåŠ¡æ˜¯ä¸€ä¸ªåŸºäº Express çš„åŠ¨æ€ HTML æ¸²æŸ“å¼•æ“ï¼Œæ”¯æŒé€šé…è·¯ç”±ã€è·¯ç”±è§„åˆ™åŒ¹é…ã€æ¨¡æ¿å˜é‡æ›¿æ¢å’Œä¸‰æ–¹ API å˜é‡æŸ¥è¯¢ã€‚

## æ ¸å¿ƒç‰¹æ€§

### 1. é€šé…è·¯ç”±

æ¸²æŸ“æœåŠ¡ä½¿ç”¨ `app.get('*')` å¤„ç†æ‰€æœ‰è·¯å¾„è¯·æ±‚ï¼Œä¸å†ä½¿ç”¨å›ºå®šçš„ `/render` ç«¯ç‚¹ã€‚

**å·¥ä½œæµç¨‹ï¼š**
```
ç”¨æˆ·è®¿é—®ä»»æ„è·¯å¾„
    â†“
æå– host å’Œ path
    â†“
æŸ¥è¯¢è·¯ç”±è§„åˆ™
    â†“
åŒ¹é…æ¨¡æ¿
    â†“
æ¸²æŸ“å¹¶è¿”å› HTML
```

**ç¤ºä¾‹ï¼š**
```bash
# æ‰€æœ‰è¿™äº›è¯·æ±‚éƒ½ä¼šè¢«å¤„ç†
curl http://localhost:3001/
curl http://localhost:3001/about
curl http://localhost:3001/blog/post-1
curl http://localhost:3001/product/123
```

### 2. è·¯ç”±è§£æå™¨ï¼ˆRouteResolverï¼‰

#### è·¯ç”±åŒ¹é…ç±»å‹

**Exactï¼ˆç²¾ç¡®åŒ¹é…ï¼‰**
```javascript
pattern: "/home"
type: "exact"

âœ“ åŒ¹é…: /home
âœ— ä¸åŒ¹é…: /home/, /home/about
```

**Wildcardï¼ˆé€šé…ç¬¦åŒ¹é…ï¼‰**
```javascript
pattern: "/blog/*"
type: "wildcard"

âœ“ åŒ¹é…: /blog/post-1, /blog/2023/article
âœ— ä¸åŒ¹é…: /news/blog
```

**Regexï¼ˆæ­£åˆ™åŒ¹é…ï¼‰**
```javascript
pattern: "^/product/\\d+$"
type: "regex"

âœ“ åŒ¹é…: /product/123, /product/456
âœ— ä¸åŒ¹é…: /product/abc, /product
```

#### åŒ¹é…ä¼˜å…ˆçº§

1. **åŸŸåä¼˜å…ˆ**ï¼šå…·ä½“åŸŸåçš„è§„åˆ™ä¼˜å…ˆäº `default` åŸŸå
2. **ä¼˜å…ˆçº§æ’åº**ï¼šç›¸åŒåŸŸåçš„è§„åˆ™æŒ‰ `priority` å­—æ®µé™åºæ’åˆ—
3. **æ—¶é—´æ’åº**ï¼šä¼˜å…ˆçº§ç›¸åŒæ—¶ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´é™åº

```javascript
// æŸ¥è¯¢é¡ºåºç¤ºä¾‹
const sortedRules = [
  // 1. å…·ä½“åŸŸåè§„åˆ™ï¼ˆæŒ‰ priority å’Œæ—¶é—´æ’åºï¼‰
  ...rules.filter(r => r.domain === 'example.com'),
  // 2. é»˜è®¤åŸŸåè§„åˆ™ï¼ˆæŒ‰ priority å’Œæ—¶é—´æ’åºï¼‰
  ...rules.filter(r => r.domain === 'default')
];
```

### 3. ä¸‰æ–¹ API å˜é‡æŸ¥è¯¢

#### é…ç½®æ–¹å¼

åœ¨ Domain æ¨¡å‹çš„ `config` å­—æ®µä¸­è®¾ç½® `api_url`ï¼š

```json
{
  "host": "example.com",
  "app_name": "My App",
  "email": "info@example.com",
  "config": {
    "api_url": "https://api.example.com/variables"
  },
  "status": "active"
}
```

#### è°ƒç”¨æ–¹å¼

ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨é…ç½®çš„ APIï¼Œå¹¶ä¼ é€’ä»¥ä¸‹å‚æ•°ï¼š

```bash
GET https://api.example.com/variables?host=example.com&path=/home&domain=example.com

# è¯·æ±‚å¤´
User-Agent: Webbox-Render-Service/1.0
```

#### API å“åº”æ ¼å¼

API åº”è¿”å› JSON å¯¹è±¡ï¼Œæ‰€æœ‰å­—æ®µå°†ä½œä¸ºæ¨¡æ¿å˜é‡ï¼š

```json
{
  "title": "Welcome to Example",
  "description": "Dynamic content from API",
  "keywords": "example, demo, api",
  "featured_products": ["Product A", "Product B"],
  "promotion_code": "SAVE20"
}
```

#### é”™è¯¯å¤„ç†

- **è¶…æ—¶**ï¼š5ç§’åè‡ªåŠ¨æ”¾å¼ƒï¼ˆä¸å½±å“é¡µé¢æ¸²æŸ“ï¼‰
- **å¤±è´¥**ï¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼Œç»§ç»­ä½¿ç”¨æ•°æ®åº“å˜é‡æ¸²æŸ“
- **æ ¼å¼é”™è¯¯**ï¼šä»…ä½¿ç”¨æœ‰æ•ˆçš„ JSON å­—æ®µ

### 4. å˜é‡åˆå¹¶ç­–ç•¥

#### åˆå¹¶é¡ºåº

å˜é‡æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§åˆå¹¶ï¼ˆåé¢çš„ä¼šè¦†ç›–å‰é¢çš„ï¼‰ï¼š

```javascript
{
  // 1. åŸŸååŸºç¡€å˜é‡ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰
  app_name: domainConfig.app_name,
  email: domainConfig.email,
  domain: host,
  path: path,

  // 2. æ¨¡æ¿è‡ªå®šä¹‰å˜é‡ï¼ˆä¸­ç­‰ä¼˜å…ˆçº§ï¼‰
  ...templateVars,

  // 3. API è¿”å›å˜é‡ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
  ...apiVars
}
```

#### ç¤ºä¾‹

**æ•°æ®åº“é…ç½®ï¼š**
```json
// Domain
{
  "app_name": "My Store",
  "email": "support@store.com"
}

// CustomTemplate
{
  "variables": {
    "title": "Default Title",
    "price": "$99"
  }
}
```

**API è¿”å›ï¼š**
```json
{
  "title": "Special Offer",
  "discount": "20%"
}
```

**æœ€ç»ˆå˜é‡ï¼š**
```json
{
  "app_name": "My Store",     // æ¥è‡ª Domain
  "email": "support@store.com", // æ¥è‡ª Domain
  "domain": "example.com",      // ç³»ç»Ÿè‡ªåŠ¨
  "path": "/home",              // ç³»ç»Ÿè‡ªåŠ¨
  "title": "Special Offer",     // API è¦†ç›–æ¨¡æ¿
  "price": "$99",               // æ¥è‡ªæ¨¡æ¿
  "discount": "20%"             // æ¥è‡ª API
}
```

### 5. æ¨¡æ¿å˜é‡æ›¿æ¢

#### è‡ªå®šä¹‰å˜é‡

ä½¿ç”¨ `{variable_name}` è¯­æ³•ï¼š

```html
<h1>{title}</h1>
<p>Welcome to {app_name}</p>
<p>Contact: {email}</p>
<span>Price: {price}</span>
<span>Discount: {discount}</span>
```

#### å†…ç½®å˜é‡

ç³»ç»Ÿè‡ªåŠ¨æä¾›ä»¥ä¸‹å†…ç½®å˜é‡ï¼š

| å˜é‡ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `{timestamp}` | ISO 8601 æ—¶é—´æˆ³ | `2025-12-11T06:00:00.000Z` |
| `{year}` | å½“å‰å¹´ä»½ | `2025` |
| `{date}` | å½“å‰æ—¥æœŸ | `2025-12-11` |

```html
<footer>
  <p>&copy; {year} {app_name}. All rights reserved.</p>
  <p>Generated at: {timestamp}</p>
</footer>
```

### 6. ç¼“å­˜æœºåˆ¶

#### ç¼“å­˜ç­–ç•¥

- **é”®æ ¼å¼**ï¼š`route:{host}:{path}`
- **TTL**ï¼š300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
- **å­˜å‚¨**ï¼šå†…å­˜ Map

#### ç¼“å­˜æ•°æ®

ç¼“å­˜åŒ…å«å®Œæ•´çš„è§£æç»“æœï¼š

```javascript
{
  template: "HTML content...",
  variables: { /* åˆå¹¶åçš„æ‰€æœ‰å˜é‡ */ },
  templateId: ObjectId,
  templateName: "Homepage Template",
  ruleId: ObjectId,
  timestamp: 1702281600000
}
```

#### æ¸…é™¤ç¼“å­˜

**æ¸…é™¤ç‰¹å®šåŸŸåï¼š**
```bash
curl -X POST http://localhost:3001/clear-cache \
  -H "Content-Type: application/json" \
  -d '{"domain":"example.com"}'
```

**æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼š**
```bash
curl -X POST http://localhost:3001/clear-cache \
  -H "Content-Type: application/json" \
  -d '{}'
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºç¡€é…ç½®

**æ­¥éª¤ 1ï¼šåˆ›å»ºåŸŸå**
```bash
POST /api/admin/domains
{
  "host": "example.com",
  "app_name": "Example Store",
  "email": "support@example.com",
  "config": {
    "api_url": "https://api.example.com/variables"
  }
}
```

**æ­¥éª¤ 2ï¼šåˆ›å»ºæ¨¡æ¿**
```bash
POST /api/admin/custom-templates
{
  "name": "homepage",
  "display_name": "é¦–é¡µæ¨¡æ¿",
  "domain": "example.com",
  "content": "<html><body><h1>{title}</h1><p>{description}</p></body></html>",
  "variables": {
    "title": "Welcome",
    "description": "Default description"
  }
}
```

**æ­¥éª¤ 3ï¼šåˆ›å»ºè·¯ç”±è§„åˆ™**
```bash
POST /api/admin/routes
{
  "pattern": "/",
  "type": "exact",
  "domain": "example.com",
  "template_id": "{{template_id}}",
  "priority": 100,
  "enabled": true
}
```

### 2. è®¿é—®æ¸²æŸ“

```bash
# è®¿é—®é¦–é¡µ
curl http://localhost:3001/ -H "Host: example.com"

# ç³»ç»Ÿæ‰§è¡Œæµç¨‹ï¼š
# 1. æå– host=example.com, path=/
# 2. æŸ¥è¯¢è·¯ç”±è§„åˆ™ï¼ŒåŒ¹é…åˆ° pattern="/"
# 3. åŠ è½½æ¨¡æ¿å’ŒåŸŸåé…ç½®
# 4. è°ƒç”¨ https://api.example.com/variables?host=example.com&path=/
# 5. åˆå¹¶å˜é‡
# 6. æ¸²æŸ“ HTML
# 7. è¿”å›ç»“æœ
```

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Express.js
- **æ•°æ®åº“**: MongoDB (via Mongoose)
- **HTTP å®¢æˆ·ç«¯**: axios
- **æ¨¡æ¿å¼•æ“**: è‡ªå®šä¹‰å˜é‡æ›¿æ¢
- **ç¼“å­˜**: å†…å­˜ Map

## æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜æœºåˆ¶**ï¼šå‡å°‘æ•°æ®åº“æŸ¥è¯¢å’Œ API è°ƒç”¨
2. **è¶…æ—¶ä¿æŠ¤**ï¼šAPI è°ƒç”¨ 5 ç§’è¶…æ—¶
3. **å¼‚æ­¥å¤„ç†**ï¼šPromise.all å¹¶è¡ŒåŠ è½½æ•°æ®
4. **ç´¢å¼•ä¼˜åŒ–**ï¼šæ•°æ®åº“å­—æ®µå»ºç«‹é€‚å½“ç´¢å¼•

## é”™è¯¯å¤„ç†

### 404 Not Found

è®¿é—®æœªé…ç½®è·¯ç”±è§„åˆ™çš„è·¯å¾„æ—¶è¿”å›ç²¾ç¾çš„ 404 é¡µé¢ï¼š

```html
<!DOCTYPE html>
<html>
<head><title>404 - Page Not Found</title></head>
<body>
  <h1>404</h1>
  <p>é¡µé¢æœªæ‰¾åˆ°</p>
  <code>example.com/unknown</code>
  <p>æœªé…ç½®åŒ¹é…çš„è·¯ç”±è§„åˆ™</p>
</body>
</html>
```

### 500 Internal Error

æ¸²æŸ“è¿‡ç¨‹å‡ºé”™æ—¶è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š

```html
<!DOCTYPE html>
<html>
<head><title>500 - Internal Server Error</title></head>
<body>
  <h1>500</h1>
  <p>æœåŠ¡å™¨å†…éƒ¨é”™è¯¯</p>
  <pre>é”™è¯¯æ¶ˆæ¯å’Œå †æ ˆè·Ÿè¸ª</pre>
</body>
</html>
```

## æ—¥å¿—è¾“å‡º

### æ­£å¸¸è¯·æ±‚

```
ğŸ“ example.com/home
âœ… Matched: /home (exact)
âœ“ API variables fetched from: https://api.example.com/variables
âœ… Homepage Template
```

### ç¼“å­˜å‘½ä¸­

```
ğŸ“ example.com/home
âœ“ Cache hit: route:example.com:/home
âœ… Homepage Template
```

### é”™è¯¯æƒ…å†µ

```
ğŸ“ example.com/unknown
No rules found for: example.com
```

```
âŒ Render error: Template not found
```

## å¼€å‘è°ƒè¯•

### æœ¬åœ°æµ‹è¯•

**.env é…ç½®ï¼š**
```bash
NODE_ENV=development
DEV_HOST=example.com  # å¼€å‘ç¯å¢ƒå›ºå®š host
```

**æµ‹è¯•å‘½ä»¤ï¼š**
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3001/health

# Demo é¡µé¢
curl http://localhost:3001/demo

# æµ‹è¯•é€šé…è·¯ç”±
curl http://localhost:3001/any-path

# æ¸…é™¤ç¼“å­˜
curl -X POST http://localhost:3001/clear-cache
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æ—¥å¿—
tail -f logs/render-service.log

# æŸ¥çœ‹æœ€è¿‘æ—¥å¿—
tail -20 logs/render-service.log
```

## ç”Ÿäº§éƒ¨ç½²

### ç¯å¢ƒå˜é‡

```bash
NODE_ENV=production
MONGODB_URI=mongodb://user:pass@host:27017/webbox?authSource=admin
RENDER_PORT=3001
```

### æ€§èƒ½å»ºè®®

1. **ä½¿ç”¨ Redis ç¼“å­˜**ï¼šæ›¿æ¢å†…å­˜ç¼“å­˜ä»¥æ”¯æŒå¤šå®ä¾‹
2. **é…ç½®åå‘ä»£ç†**ï¼šä½¿ç”¨ Nginx å¤„ç†é™æ€èµ„æº
3. **å¯ç”¨ CDN**ï¼šç¼“å­˜æ¸²æŸ“ç»“æœ
4. **ç›‘æ§æ—¥å¿—**ï¼šé›†æˆ Sentry æˆ–å…¶ä»–ç›‘æ§æœåŠ¡

## æ€»ç»“

æ¸²æŸ“æœåŠ¡é€šè¿‡é€šé…è·¯ç”±ã€çµæ´»çš„è·¯ç”±åŒ¹é…ã€å¤šæºå˜é‡åˆå¹¶å’Œæ™ºèƒ½ç¼“å­˜ï¼Œæä¾›äº†å¼ºå¤§çš„åŠ¨æ€ HTML æ¸²æŸ“èƒ½åŠ›ã€‚æ”¯æŒæ•°æ®åº“å˜é‡å’Œä¸‰æ–¹ API å˜é‡çš„æ— ç¼é›†æˆï¼Œé€‚ç”¨äºå¤šåŸŸåã€å¤šæ¨¡æ¿çš„å¤æ‚åœºæ™¯ã€‚
